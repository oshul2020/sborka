{% extends "b_layout.html" %}
{% import 'b_base.html' as base %}

{% macro balance_dialog() -%}
<div class="modal fade " id="balance_dialog" tabindex="-1" role="dialog">
	<div class="modal-dialog modal-dialog-centered" role="document">
		<div class="modal-content">
			<div class="modal-body">
				<h5 class="mb-2" id="dialog_title"></h5>
				<hr/>
				<div class="row m-1">
					<label class="text-right py-2 mr-2">оплатить</label>	
					<input class="form-control text-right mr-2 w-25"  type="number" id="amount" min="1" max="100">
					<label class="text-left py-2">поездок</label>	
				</div>	
				<div class="d-flex m-1">
					<button class="btn btn-secondary w-25 ml-auto" onclick="send()">ОК</button>
				</div>
			</div>
		</div>
	</div>
</div>
{%- endmacro %}

{% macro users_list(users) -%}
	{% for u in users %}
		<div class="u_container" id="container_{{u.id}}">
		<div class="w_info"> 
			<div class="u_title" id="title_{{u.id}}">{{u.title}}</div>
		</div>
			<div id="cmd_{{u.id}}" class="w_cmd">	
				<div id="account_{{u.id}}" class="u_account c1" onclick="dialog(this, {{u.id}})">{{u.account}}</div>		
			</div>
		</div>
		{% if curr_user.id == u.id %}
			<script>
				$('#account_badge').text({{u.account}});
			</script>
		{% endif %}
	{% endfor %}
{%- endmacro %}


{% block main %}
<div class="b_mainframe" id="mainFrame">
	<div class="d-flex mx-3">
		<h5 class="py-2">количество поездок</h5>
		<input type="text" class="form-control text-right w-50 ml-auto" id="filter" placeholder="фильтр" oninput="user_filter(this)">
	</div>	
	<div class="container" id="list_container">
		{{users_list(users)}}
	</div>	
</div>

{{ balance_dialog() }}
	
<script>
	var columns = {};
	
	
	$('#balance_dialog').on('shown.bs.modal', function () {
		$('#amount').focus();
		$('#amount').select(); 
	})  
	
	function dialog(elm, id) {
		columns['user'] = id;
		var account = Number($('#account_'+id).text());
		$('#dialog_title').text($('#title_'+id).text());
		$('#amount').val(Math.abs(account));
		$('#balance_dialog').modal('show');	
	}
	
	function send() {
		var amount = $('#amount').val();
		var id = columns['user'];
		
		if (!amount || amount==0) {
			return;
		}
		
		$('#balance_dialog').modal('toggle');
		columns['cmd'] = 'balance';
		columns['amount'] = amount;
				
		$('#cmd_'+id).html('<div class="u_account text-secondary">&#9203;</div>');
		$.ajax({
			url: '/bus/balance',
			data: columns,
			type: 'POST',
			dataType: 'HTML',
			success: function(res) {
				$('#list_container').html(res);
			},
			error: function(error) {
				console.log(error);			
			}		
		});
	}
	
	function user_filter(elm) {
		all = $(".u_container")
		var filter_txt = $(elm).val().toUpperCase();
		
		all.each(function(idx, c) {
			var text = $(c).children('.w_info').text().toUpperCase();		
			if (text.indexOf(filter_txt) == -1) {
				$(c).hide();
			} else {
				$(c).show();
			}
		});
	};
	

</script>	
	
{% endblock %}